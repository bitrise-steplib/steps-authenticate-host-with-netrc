format_version: "11"
default_step_lib_source: https://github.com/bitrise-io/bitrise-steplib.git

app:
  envs:
  # define these in your .bitrise.secrets.yml
  - HOST: testhost.com
  - USERNAME: testuser
  - PASSWORD: testpassword

workflows:
  test_create_netrc_file:
    steps:
    - script:
        title: Back up .netrc
        inputs:
        - content: |-
            set -ex
            if [ -f ~/.netrc ]; then
            mv ~/.netrc ~/.bk.netrc
            fi
    - path::./:
        title: Execute step
        inputs:
        - host: $HOST
        - username: $USERNAME
        - password: $PASSWORD
    - path::./:
        title: Execute step second time
        inputs:
        - host: $HOST
        - username: $USERNAME
        - password: $PASSWORD
    - script:
        title: Output (generated by the Step) tests
        inputs:
        - content: |-
            set -e

            cat ~/.netrc
            echo ""
    - script:
        title: Check file permission
        inputs:
        - content: |-
            set -ex

            if [ $(stat -f "%A" ~/.netrc) != 600 ]; then
              echo "netrc file permission is not 600"
              exit 1
            fi
    - script:
        title: Restore .netrc
        inputs:
        - content: |-
            set -ex
            if [ -f ~/.bk.netrc ]; then
              rm -rf ~/.netrc
              mv ~/.bk.netrc ~/.netrc
            fi
